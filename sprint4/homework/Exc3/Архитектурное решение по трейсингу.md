# Архитектурное решение по трейсингу

---

## Мотивация

Система «Александрит» сталкивается с проблемами, когда заказы зависают или теряются в процессе обработки. Это приводит к снижению удовлетворённости клиентов, потерям крупных контрактов и ухудшению репутации. Внедрение трейсинга позволит:

- **Технически**:
    1. Быстро выявлять места, где заказы застревают.
    2. Диагностировать причины потери сообщений.
    3. Улучшить процесс дебагинга для команд поддержки и разработки.

- **Бизнес-метрики**:
    1. Сокращение времени на обработку инцидентов (MTTR).
    2. Снижение количества недовольных клиентов.
    3. Улучшение SLA для внешних и внутренних клиентов.

---

## Системы, которые следует покрыть трейсингом

Трейсинг необходимо внедрить во всех системах, взаимодействующих с заказами. Основные точки:
1. **Онлайн-магазин**:
    - Стадии создания заказа (INITIATED → FILE_UPLOADED → SUBMITTED).
2. **MES**:
    - Расчёт стоимости заказа (PRICE_CALCULATED).
    - Переходы статусов внутри производства (MANUFACTURING_STARTED → MANUFACTURING_COMPLETED).
    - Работа с RabbitMQ.
3. **CRM**:
    - Подтверждение заказов (MANUFACTURING_APPROVED).
    - Завершение заказов (CLOSED).

Особое внимание нужно уделить интеграции RabbitMQ, так как сообщения теряются или обрабатываются некорректно.

---

## Данные, которые должны попадать в трейсинг

Для качественного трейсинга необходим сбор следующих данных:
1. **ID заказа** (универсальный идентификатор).
2. **Текущий статус заказа** (по состояниям статусов).
3. **Время обработки в каждом компоненте**.
4. **Идентификатор сообщения в очереди RabbitMQ** (Message ID).
5. **Ошибки и исключения**, связанные с обработкой заказа.
6. **Трассировка вызовов между сервисами**:
    - Методы API и их параметры.
    - Результаты выполнения запросов.

---

## Предлагаемое решение

### Технологии
1. **OpenTelemetry**:
    - Для сбора трейсинговых данных из приложений (онлайн-магазин, CRM, MES).
    - Обеспечивает кросс-языковую совместимость (Java, C#).
2. **Jaeger**:
    - Для хранения и визуализации трейсинговых данных.
    - Поддерживает распределённый трейсинг.
3. **RabbitMQ Tracing Plugin**:
    - Для мониторинга сообщений в очереди.

### Компоненты
1. **Collector (Jaeger)**:
    - Сбор данных трейсинга.
2. **Agent (OpenTelemetry)**:
    - Интеграция в код онлайн-магазина, CRM и MES.
3. **Trace Storage**:
    - Хранилище для данных трейсинга.
4. **Dashboards**:
    - Визуализация зависших и обработанных заказов в реальном времени.

### Доработки системы
- Интеграция OpenTelemetry SDK в приложения (Java и C#).
- Настройка логирования в RabbitMQ (включение трейсинга сообщений).
- Связывание всех операций через уникальный идентификатор заказа (trace ID).

---

## Компромиссы

1. **Сложность встраивания в MES**:
    - MES написан на C#, что требует дополнительных усилий для интеграции OpenTelemetry.
2. **Проприетарные системы**:
    - Некоторая логика в MES может быть закрытой и не позволять внедрение трейсинга напрямую.
3. **Затраты на инфраструктуру**:
    - Необходимость выделения ресурсов на хранилище трейсинга (Jaeger) и его обслуживание.

---

## Аспекты безопасности

1. **Аутентификация и авторизация**:
    - Доступ к системе трейсинга только по корпоративным учётным записям с ролями уровня "Поддержка" или "Разработка".
2. **Шифрование данных**:
    - Шифрование всех трейсинговых данных в хранилище (TLS, AES).
3. **Защита RabbitMQ**:
    - Ограничение доступа к плагину трейсинга через ACL.
4. **Обфускация конфиденциальных данных**:
    - Удаление или маскирование PII (например, данных клиента).

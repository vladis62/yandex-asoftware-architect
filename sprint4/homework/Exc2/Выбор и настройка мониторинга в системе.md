# Выбор и настройка мониторинга в системе

## Раздел 1: Мотивация

Система компании «Александрит» требует улучшения мониторинга из-за роста нагрузки, увеличения количества жалоб клиентов и потери контрактов. Без мониторинга невозможно:
- Оперативно реагировать на инциденты.
- Анализировать узкие места в системе и планировать масштабирование.
- Улучшать пользовательский опыт и предоставлять стабильный API для клиентов.

**Что даст мониторинг:**
1. Повышение стабильности системы.
2. Улучшение пользовательского опыта (быстрая загрузка интерфейсов, надёжное API).
3. Поддержание SLA для внутренних и внешних клиентов.
4. Возможность выявления узких мест в системе и их устранения.

---

## Раздел 2: Выбор подхода к мониторингу

1. **RED (Rate, Errors, Duration):** Используется для API, чтобы отслеживать:
    - Количество запросов.
    - Ошибки.
    - Время отклика.
2. **Четыре золотых сигнала (Latency, Traffic, Errors, Saturation):** Используется для:
    - Работы RabbitMQ.
    - Производительности баз данных.
    - Утилизации ресурсов серверов и сетей.

---

## Раздел 3: Метрики и их настройка

### RabbitMQ
- **Number of dead-letter-exchange letters in RabbitMQ**:
    - Зачем: Отслеживать сообщения, которые не удалось обработать.
    - Ярлыки: Очередь, причина отказа.
- **Number of messages in flight in RabbitMQ**:
    - Зачем: Оценить текущую нагрузку на очереди.
    - Ярлыки: Очередь.

### API
- **Number of requests (RPS) for internet shop API / CRM API / MES API**:
    - Зачем: Оценить общую нагрузку.
    - Ярлыки: Метод (GET, POST), клиент (внешний, внутренний).
- **Response time (latency) for shop API / CRM API / MES API**:
    - Зачем: Оценивать производительность API и соответствие SLA.
    - Ярлыки: Клиент, метод.
- **Number of HTTP 200 / 500 for shop API / CRM API / MES API**:
    - Зачем: Отслеживать успешные и ошибочные запросы.
    - Ярлыки: Тип ответа (200, 500), клиент.

### Ресурсы серверов
- **CPU % for shop API / CRM API / MES API**:
    - Зачем: Определить, где происходят перегрузки.
    - Ярлыки: Приложение.
- **Memory Utilisation for shop API / CRM API / MES API**:
    - Зачем: Контролировать потребление памяти.
    - Ярлыки: Приложение.

### Базы данных
- **Number of connections for shop db instance / MES db instance**:
    - Зачем: Отслеживать нагрузку на базу данных.
    - Ярлыки: Приложение.
- **Memory Utilisation for shop db instance / MES db instance**:
    - Зачем: Контролировать использование памяти базы.
    - Ярлыки: Тип операции (чтение/запись).
- **Size of shop db instance / MES db instance**:
    - Зачем: Анализировать рост объёма данных.
    - Ярлыки: Приложение.

### Сети
- **Kb transferred (received) / provided (sent) for shop API / CRM API / MES API**:
    - Зачем: Отслеживать сетевую активность.
    - Ярлыки: Приложение, клиент.

---

## Раздел 4: План действий

### Этап 1: Подготовка инфраструктуры
1. Создать инстанс Prometheus для хранения временных рядов.
2. Развернуть систему визуализации метрик Grafana.
3. Настроить централизованное логирование с использованием ELK-стека.

### Этап 2: Сбор метрик
4. Настроить экспорт метрик для RabbitMQ с использованием плагина RabbitMQ Exporter.
5. Настроить экспорт метрик из API (использовать библиотеки Prometheus для Java и C#).
6. Настроить мониторинг баз данных с использованием встроенных инструментов Yandex Cloud.

### Этап 3: Настройка алёртов
7. Настроить алёрты на критические метрики:
    - Ошибки (HTTP 500, dead-letter queue).
    - Время отклика API (превышение SLA).
    - Высокая утилизация CPU и памяти.
8. Включить уведомления через Slack или Email.

### Этап 4: Визуализация и тестирование
9. Создать дашборды для:
    - RabbitMQ (очереди, dead-letter, in-flight).
    - API (RPS, ошибки, латентность).
    - Утилизации ресурсов.
10. Провести нагрузочное тестирование, чтобы проверить корректность метрик и алёртов.

### Этап 5: Внедрение и обучение
11. Внедрить мониторинг в продакшн.
12. Провести обучение команды по работе с дашбордами и интерпретации данных.

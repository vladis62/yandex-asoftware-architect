# Архитектурное решение по логированию


Для эффективного логирования необходимо настроить сбор логов в системах:
- **Онлайн-магазин**
- **CRM**
- **MES**
- **RabbitMQ** (для мониторинга сообщений и интеграции между системами)

## Логи, которые необходимо собирать
### Логи уровня INFO:
1. **Изменение статуса заказа**:
    - Время изменения статуса.
    - Идентификатор покупателя.
    - Номер заказа.
    - Новый и старый статус заказа.
    - Система, изменившая статус (Онлайн-магазин, CRM, MES).

2. **Создание нового заказа**:
    - Время создания.
    - Идентификатор покупателя.
    - Номер заказа.
    - Используемая система (онлайн-магазин или CRM).

3. **Загрузка 3D-модели**:
    - Время загрузки.
    - Идентификатор покупателя.
    - Номер заказа.
    - Размер файла модели.

4. **Изменения в расчетах стоимости**:
    - Время расчета стоимости.
    - Идентификатор заказа.
    - Результат расчета стоимости (успешный/неудачный).
    - Время обработки (например, если расчет занял больше 5 минут).

5. **Операции в MES (например, начало и завершение производства)**:
    - Время начала и завершения работы.
    - Идентификатор заказа.
    - Идентификатор оператора.

### Другие уровни логирования:
1. **ERROR**:
    - Ошибки выполнения на уровне бизнес-логики и сервисов.
    - Ошибки интеграции (например, при невозможности рассчитать стоимость изделия или при сбоях в RabbitMQ).
    - Ошибки работы с базой данных или другими сервисами.

2. **DEBUG**:
    - Логирование запросов и ответов API между системами.
    - Данные, полезные для диагностики нестандартных ситуаций, но не критичные для мониторинга на постоянной основе.

3. **TRACE**:
    - Логирование в случае необходимости детализированного анализа поведения системы (например, сложные операции с большим количеством шагов или аномальное поведение, требующее детального анализа).

## Мотивация
Внедрение логирования принесет следующие преимущества компании:
1. **Ускорение диагностики проблем**: Логирование позволит оперативно выявлять причину ошибок и нестандартных ситуаций без необходимости ждать отчеты от клиентов.
2. **Проактивный мониторинг**: Быстрое выявление аномалий в системе (например, резкое увеличение количества заказов или ошибки на определенных этапах).
3. **Повышение производительности**: Логирование и анализ событий помогут выявить узкие места в системе и предложить оптимизации для повышения производительности.
4. **Улучшение качества обслуживания клиентов**: Снижение времени реакции на запросы клиентов и снижение их недовольства из-за ошибок или задержек в процессе.

### Бизнес-метрики:
1. **Время на диагностику проблем** — снижение времени, необходимого для обнаружения и устранения проблем.
2. **Количество повторных жалоб клиентов** — снижение числа жалоб от клиентов, связанных с ошибками.
3. **Время выполнения заказа** — ускорение обработки заказов благодаря более быстрой диагностике.
4. **Нагрузка на службу поддержки** — снижение числа запросов в службу поддержки за счет улучшения процесса мониторинга и анализа ошибок.
5. **Производительность системы** — улучшение быстродействия системы за счет выявления и устранения узких мест.

## Приоритетные системы для логирования и трейсинга
Первоначально логирование и трейсинг необходимо настроить для следующих систем:
1. **Онлайн-магазин**:
    - Важность: это интерфейс для клиентов, где начинается весь процесс. Проблемы на этом этапе могут привести к недовольству клиентов и потерянным заказам.

2. **MES**:
    - Важность: это система, которая управляет производственными процессами. Ошибки в MES могут привести к задержкам в производстве, что напрямую влияет на срок выполнения заказов.

3. **RabbitMQ**:
    - Важность: мониторинг сообщений и ошибок в очередях поможет выявить проблемы с синхронизацией между системами.

После того как эти системы будут настроены для логирования и трейсинга, можно будет расширять логи и для других компонентов (CRM, базы данных и т. д.).

## Предлагаемое решение
### Технологии логирования:
1. **Для сбора логов**:
    - Использование **ELK Stack** (Elasticsearch, Logstash, Kibana) для хранения и визуализации логов.
    - **Filebeat** на каждом из серверов для отправки логов в Logstash.

2. **Для трейсинга**:
    - Внедрение **OpenTelemetry** для сбора распределенных трассировок (trace logs), что поможет отслеживать процессы по всей системе, включая взаимодействие между различными микросервисами.

3. **Мониторинг сообщений RabbitMQ**:
    - Использование **RabbitMQ Management Plugin** для мониторинга очередей и сообщений в реальном времени.

### Политика безопасности:
1. **Работа с чувствительными данными**:
    - Логи, содержащие персональные данные или финансовую информацию, должны быть зашифрованы и доступны только ограниченному кругу сотрудников (например, разработчики, администраторы).
    - Платформа логирования должна быть защищена с использованием аутентификации и авторизации OAuth.

2. **Политика хранения логов**:
    - Логи будут храниться в Elasticsearch в течение 30 дней для оперативного анализа. После этого они могут быть архивированы в более дешевые хранилища для долгосрочного хранения.
    - Размер логов будет контролироваться с помощью политики ретенции: старые логи будут автоматически удаляться по мере достижения предельного объема.

## Мероприятия для превращения системы сбора логов в систему анализа
1. **Настройка алертинга**:
    - Оповещения на основе уровня логов (например, ERROR или WARN) для быстрой реакции на возможные инциденты.
    - Создание алертов по аномальным событиям (например, увеличение количества заказов или ошибок в одном месте).

2. **Поиск аномалий**:
    - Использование машинного обучения для обнаружения аномалий в потоке логов. Например, если количество созданных заказов за секунду увеличилось в 100 раз, это может указывать на DDoS-атаку или баг в системе.
    - Визуализация аномалий с помощью Kibana или других аналитических инструментов.
